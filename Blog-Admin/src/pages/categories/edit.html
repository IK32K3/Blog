<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Category - Blog Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Use CDN links for reliable loading on GitHub Pages -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Custom CSS with relative path -->
  <link href="../../assets/css/style.css" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <div data-inject="../../components/header.html"></div>

  <!-- Sidebar -->
  <div data-inject="../../components/sidebar.html"></div>
  <div class="sidebar-overlay"></div>

  <!-- Main Content -->
  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Edit Category</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="../dashboard.html">Home</a></li>
          <li class="breadcrumb-item"><a href="./index.html">Categories</a></li>
          <li class="breadcrumb-item active">Edit Category</li>
        </ol>
      </nav>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Category Information</h5>

              <!-- Edit Category Form -->
              <form class="row g-3" id="editCategoryForm">
                <input type="hidden" id="categoryId" name="id">
                
                <!-- Primary Information -->
                <div class="col-md-6">
                  <label for="categoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="categoryName" name="name" required>
                  <div class="form-text">The name is how it appears on your site.</div>
                </div>

                <div class="col-md-6">
                  <label for="categorySlug" class="form-label">Slug</label>
                  <input type="text" class="form-control" id="categorySlug" name="slug" readonly>
                  <div class="form-text">The "slug" is automatically generated from the name and is used in URLs.</div>
                </div>

                <!-- Default Language Selection -->
                <div class="col-md-6">
                  <label for="languageId" class="form-label">Primary Language <span class="text-danger">*</span></label>
                  <select class="form-select" id="languageId" name="language_id" required>
                    <option value="1">English</option>
                    <option value="2">Spanish</option>
                    <option value="3">French</option>
                    <option value="4">German</option>
                    <option value="5">Vietnamese</option>
                  </select>
                  <div class="form-text">The primary language for this category.</div>
                </div>

                <div class="col-md-6">
                  <label for="isActive" class="form-label">Status</label>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active">
                    <label class="form-check-label" for="isActive">Active</label>
                  </div>
                  <div class="form-text">Inactive categories won't be visible on the website.</div>
                </div>

                <div class="col-12">
                  <label for="categoryDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="categoryDescription" name="description" rows="4"></textarea>
                  <div class="form-text">The description is not prominent by default; however, some themes may show it.</div>
                </div>

                <!-- Statistics Card -->
                <div class="col-12 mt-4">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h5 class="card-title">Category Statistics</h5>
                      <div class="row">
                        <div class="col-md-4">
                          <div class="stat-card p-3 mb-2 bg-white rounded">
                            <div class="stat-card-title">Total Posts</div>
                            <div class="stat-card-value" id="totalPosts">32</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="stat-card p-3 mb-2 bg-white rounded">
                            <div class="stat-card-title">Available Translations</div>
                            <div class="stat-card-value" id="translationCount">3</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="stat-card p-3 mb-2 bg-white rounded">
                            <div class="stat-card-title">Last Updated</div>
                            <div class="stat-card-value" id="lastUpdated">2023-10-15</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Translations Section -->
                <div class="col-12 mt-4">
                  <h5 class="card-subtitle mb-3">Translations</h5>
                  <p class="text-muted mb-4">Edit translations for this category in other languages.</p>
                  
                  <!-- Translations Accordion -->
                  <div class="accordion" id="translationsAccordion">
                    <!-- Spanish Translation -->
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="spanishHeading">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#spanishTranslation" aria-expanded="true" aria-controls="spanishTranslation">
                          Spanish Translation
                        </button>
                      </h2>
                      <div id="spanishTranslation" class="accordion-collapse collapse show" aria-labelledby="spanishHeading" data-bs-parent="#translationsAccordion">
                        <div class="accordion-body">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <label for="spanishName" class="form-label">Name (Spanish)</label>
                              <input type="text" class="form-control" id="spanishName" name="translations[es][name]">
                            </div>
                            <div class="col-md-6">
                              <label for="spanishActive" class="form-label">Status</label>
                              <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="spanishActive" name="translations[es][is_active]" checked>
                                <label class="form-check-label" for="spanishActive">Active</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <label for="spanishDescription" class="form-label">Description (Spanish)</label>
                              <textarea class="form-control" id="spanishDescription" name="translations[es][description]" rows="3"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- French Translation -->
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="frenchHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#frenchTranslation" aria-expanded="false" aria-controls="frenchTranslation">
                          French Translation
                        </button>
                      </h2>
                      <div id="frenchTranslation" class="accordion-collapse collapse" aria-labelledby="frenchHeading" data-bs-parent="#translationsAccordion">
                        <div class="accordion-body">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <label for="frenchName" class="form-label">Name (French)</label>
                              <input type="text" class="form-control" id="frenchName" name="translations[fr][name]">
                            </div>
                            <div class="col-md-6">
                              <label for="frenchActive" class="form-label">Status</label>
                              <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="frenchActive" name="translations[fr][is_active]" checked>
                                <label class="form-check-label" for="frenchActive">Active</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <label for="frenchDescription" class="form-label">Description (French)</label>
                              <textarea class="form-control" id="frenchDescription" name="translations[fr][description]" rows="3"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- German Translation -->
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="germanHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#germanTranslation" aria-expanded="false" aria-controls="germanTranslation">
                          German Translation
                        </button>
                      </h2>
                      <div id="germanTranslation" class="accordion-collapse collapse" aria-labelledby="germanHeading" data-bs-parent="#translationsAccordion">
                        <div class="accordion-body">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <label for="germanName" class="form-label">Name (German)</label>
                              <input type="text" class="form-control" id="germanName" name="translations[de][name]">
                            </div>
                            <div class="col-md-6">
                              <label for="germanActive" class="form-label">Status</label>
                              <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="germanActive" name="translations[de][is_active]">
                                <label class="form-check-label" for="germanActive">Active</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <label for="germanDescription" class="form-label">Description (German)</label>
                              <textarea class="form-control" id="germanDescription" name="translations[de][description]" rows="3"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Vietnamese Translation -->
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="vietnameseHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vietnameseTranslation" aria-expanded="false" aria-controls="vietnameseTranslation">
                          Vietnamese Translation
                        </button>
                      </h2>
                      <div id="vietnameseTranslation" class="accordion-collapse collapse" aria-labelledby="vietnameseHeading" data-bs-parent="#translationsAccordion">
                        <div class="accordion-body">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <label for="vietnameseName" class="form-label">Name (Vietnamese)</label>
                              <input type="text" class="form-control" id="vietnameseName" name="translations[vi][name]">
                            </div>
                            <div class="col-md-6">
                              <label for="vietnameseActive" class="form-label">Status</label>
                              <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="vietnameseActive" name="translations[vi][is_active]">
                                <label class="form-check-label" for="vietnameseActive">Active</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <label for="vietnameseDescription" class="form-label">Description (Vietnamese)</label>
                              <textarea class="form-control" id="vietnameseDescription" name="translations[vi][description]" rows="3"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-check-circle me-1"></i> Save Changes
                  </button>
                  <a href="./index.html" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                  </a>
                  <button type="button" class="btn btn-danger float-end" id="deleteCategory">
                    <i class="bi bi-trash me-1"></i> Delete Category
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <div data-inject="../../components/footer.html"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Component loader
    document.addEventListener('DOMContentLoaded', () => {
      // Load components
      const components = document.querySelectorAll('[data-inject]');
      
      components.forEach(component => {
        let path = component.getAttribute('data-inject');
        
        fetch(path)
          .then(response => response.text())
          .then(html => {
            component.innerHTML = html;
          })
          .catch(error => {
            console.error('Error loading component:', path, error);
            component.innerHTML = `<div class="alert alert-danger">Failed to load component: ${path}</div>`;
          });
      });

      // Get category ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const categoryId = urlParams.get('id');
      
      if (categoryId) {
        // Set hidden category ID in form
        document.getElementById('categoryId').value = categoryId;
        
        // Load category data
        loadCategoryData(categoryId);
      } else {
        // No ID provided, redirect to categories list
        window.location.href = 'index.html';
      }

      // Set up event listeners
      setupEventListeners();
    });

    // Load category data from API
    function loadCategoryData(categoryId) {
      // In a real application, this would be an API call
      // For demo purposes, we're using mock data
      
      // Sample category data (simulate API response)
      const categoryData = {
        id: categoryId,
        name: 'Technology',
        slug: 'technology',
        language_id: 1,
        description: 'Articles about the latest tech trends, software development, gadgets, and digital innovation.',
        is_active: true,
        created_at: '2023-01-15T10:00:00',
        updated_at: '2023-10-15T14:30:00',
        posts_count: 32,
        translations: {
          es: {
            name: 'Tecnología',
            description: 'Artículos sobre las últimas tendencias tecnológicas, desarrollo de software, gadgets e innovación digital.',
            is_active: true
          },
          fr: {
            name: 'Technologie',
            description: 'Articles sur les dernières tendances technologiques, le développement de logiciels, les gadgets et l\'innovation numérique.',
            is_active: true
          },
          de: {
            name: 'Technologie',
            description: 'Artikel über die neuesten Technologietrends, Softwareentwicklung, Gadgets und digitale Innovation.',
            is_active: false
          },
          vi: {
            name: 'Công nghệ',
            description: 'Các bài viết về xu hướng công nghệ mới nhất, phát triển phần mềm, thiết bị và đổi mới kỹ thuật số.',
            is_active: false
          }
        }
      };
      
      // Fill form with category data
      fillCategoryForm(categoryData);
    }

    // Fill form with category data
    function fillCategoryForm(category) {
      // Basic information
      document.getElementById('categoryName').value = category.name || '';
      document.getElementById('categorySlug').value = category.slug || '';
      document.getElementById('languageId').value = category.language_id || 1;
      document.getElementById('isActive').checked = category.is_active || false;
      document.getElementById('categoryDescription').value = category.description || '';
      
      // Statistics
      document.getElementById('totalPosts').textContent = category.posts_count || 0;
      document.getElementById('translationCount').textContent = Object.keys(category.translations || {}).length || 0;
      document.getElementById('lastUpdated').textContent = formatDate(category.updated_at) || '-';
      
      // Translations
      if (category.translations) {
        // Spanish translation
        if (category.translations.es) {
          document.getElementById('spanishName').value = category.translations.es.name || '';
          document.getElementById('spanishDescription').value = category.translations.es.description || '';
          document.getElementById('spanishActive').checked = category.translations.es.is_active || false;
        }
        
        // French translation
        if (category.translations.fr) {
          document.getElementById('frenchName').value = category.translations.fr.name || '';
          document.getElementById('frenchDescription').value = category.translations.fr.description || '';
          document.getElementById('frenchActive').checked = category.translations.fr.is_active || false;
        }
        
        // German translation
        if (category.translations.de) {
          document.getElementById('germanName').value = category.translations.de.name || '';
          document.getElementById('germanDescription').value = category.translations.de.description || '';
          document.getElementById('germanActive').checked = category.translations.de.is_active || false;
        }
        
        // Vietnamese translation
        if (category.translations.vi) {
          document.getElementById('vietnameseName').value = category.translations.vi.name || '';
          document.getElementById('vietnameseDescription').value = category.translations.vi.description || '';
          document.getElementById('vietnameseActive').checked = category.translations.vi.is_active || false;
        }
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      // Form submission
      document.getElementById('editCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
          updateCategory(this);
        }
      });
      
      // Category name change - for demo purposes only
      document.getElementById('categoryName').addEventListener('input', function() {
        // Auto update slug based on name change (normally this would be done by the backend)
        document.getElementById('categorySlug').value = generateSlug(this.value);
      });
      
      // Delete category button
      document.getElementById('deleteCategory').addEventListener('click', function() {
        confirmDeleteCategory();
      });
    }

    // Generate slug from text
    function generateSlug(text) {
      return text
        .toString()
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/&/g, '-and-')          // Replace & with 'and'
        .replace(/[^\w\-]+/g, '')       // Remove all non-word characters
        .replace(/\-\-+/g, '-');        // Replace multiple - with single -
    }

    // Validate form
    function validateForm() {
      const nameInput = document.getElementById('categoryName');
      const languageInput = document.getElementById('languageId');
      
      let isValid = true;
      
      // Check name
      if (!nameInput.value.trim()) {
        nameInput.classList.add('is-invalid');
        isValid = false;
      } else {
        nameInput.classList.remove('is-invalid');
      }
      
      // Check language
      if (!languageInput.value) {
        languageInput.classList.add('is-invalid');
        isValid = false;
      } else {
        languageInput.classList.remove('is-invalid');
      }
      
      return isValid;
    }

    // Update category
    function updateCategory(form) {
      // In a real application, this would be an API call
      
      // Create FormData object
      const formData = new FormData(form);
      
      // For demo purposes, log the data
      console.log('Category updated with the following data:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
      
      // Prepare data object for API
      const categoryData = {
        id: formData.get('id'),
        name: formData.get('name'),
        slug: formData.get('slug'),
        language_id: formData.get('language_id'),
        is_active: formData.get('is_active') === 'on',
        description: formData.get('description') || '',
        translations: {
          es: {
            name: formData.get('translations[es][name]') || '',
            is_active: formData.get('translations[es][is_active]') === 'on',
            description: formData.get('translations[es][description]') || ''
          },
          fr: {
            name: formData.get('translations[fr][name]') || '',
            is_active: formData.get('translations[fr][is_active]') === 'on',
            description: formData.get('translations[fr][description]') || ''
          },
          de: {
            name: formData.get('translations[de][name]') || '',
            is_active: formData.get('translations[de][is_active]') === 'on',
            description: formData.get('translations[de][description]') || ''
          },
          vi: {
            name: formData.get('translations[vi][name]') || '',
            is_active: formData.get('translations[vi][is_active]') === 'on',
            description: formData.get('translations[vi][description]') || ''
          }
        }
      };
      
      console.log('Prepared data for API:', categoryData);
      
      // Show success message
      showSuccessMessage('Category updated successfully!');
    }

    // Confirm delete category
    function confirmDeleteCategory() {
      const categoryName = document.getElementById('categoryName').value;
      const totalPosts = document.getElementById('totalPosts').textContent;
      
      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      document.body.appendChild(backdrop);
      
      // Create confirm modal
      const modal = document.createElement('div');
      modal.className = 'modal fade show';
      modal.style.display = 'block';
      modal.setAttribute('tabindex', '-1');
      modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Deletion</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete the category "<strong>${categoryName}</strong>"?</p>
              <p class="text-danger"><strong>Warning:</strong> This category contains ${totalPosts} posts. Deleting this category will remove all associated posts or reassign them to a default category based on your settings.</p>
              <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger btn-confirm">Delete Category</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Handle close button
      const closeBtn = modal.querySelector('.btn-close');
      closeBtn.addEventListener('click', () => {
        modal.remove();
        backdrop.remove();
      });
      
      // Handle cancel button
      const cancelBtn = modal.querySelector('.btn-secondary');
      cancelBtn.addEventListener('click', () => {
        modal.remove();
        backdrop.remove();
      });
      
      // Handle confirm button
      const confirmBtn = modal.querySelector('.btn-confirm');
      confirmBtn.addEventListener('click', () => {
        modal.remove();
        backdrop.remove();
        
        // Delete category (in a real application, this would be an API call)
        showSuccessMessage('Category deleted successfully!');
        
        // Redirect after a short delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
      });
    }

    // Show success message
    function showSuccessMessage(message) {
      // Create toast container if it doesn't exist
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
      }
      
      // Create toast
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-white bg-success border-0';
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Initialize the Bootstrap toast
      const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
      });
      
      // Show the toast
      bsToast.show();
      
      // Remove toast after hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      return date.toISOString().split('T')[0];
    }
  </script>
</body>
</html>